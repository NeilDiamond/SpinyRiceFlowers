---
title: "Using the SpinyRiceFlowers Package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using_the_SpinyRiceFlowersPackage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The package depends on a number of R packages. To install a package, say "ggplot2", the following commands can be used. 

```{r, eval=TRUE}
if(!require('ggplot2')) {
  install.packages('ggplot2')
  library('ggplot2')
}

if(!require('ggdensity')) {
  install.packages('ggdensity')
  library('ggdensity')
}

if(!require('dplyr')) {
  install.packages('dplyr')
  library('dplyr')
}
library(SpinyRiceFlowers)
```


## Installation of the Package

Choose a directory you want to work in and save the zip file to that directory. Then use the following commands.

```{r, eval=FALSE}
install.packages("SpinyRiceFlowers_0.1.2.zip")
library(SpinyRiceFlowers)
```

## Datasets

The package includes two types of data sets, the longitudinal data sets and the Statewide evaluation data sets.

The longitudanal data sets give the the status of plants collected annually from 2017 to 2021. The data sets are:

|             |          |
|-------------|----------|
| BonThomas A | PimeleaA |
| BonThomas B | PimeleaB |
| DentonAveA  | PimeleaC |
| DentonAveB  | PimeleaD |
| IramooA     | PimeleaE |
| IramooB     | PimeleaF |


To print out the data set, just type the name. Alternatively, you can get the first few rows with the `head()`command.

```{r, echo=TRUE}
head(PimeleaA, n=10)
```


The Statewide evaluation data sets are:

|        |        |
|--------|--------|
| Site19 | Site29 |
| Site22 | Site45 |

For convenience, a number of derived data sets related to BonThomasA have been included in the package:

|                       |
|-----------------------|
| AllPlantsby2020       | 
| BonThomasADied2021    | 
| BonThomasARecruit2021 |

Information about the datsets can be obtained using the help command.

```{r, eval=FALSE}
help(AllPlantsby2020)
```

## Heatmaps

Heatmaps can be prepared using the `HeatMap()` command. Required fields include the co-ordinates of the plants, optionally the  number of plants at that co-ordinate (called the weights), the $x$ and $y$ ranges, and a title.


```{r, echo=TRUE, warning=FALSE}
HeatMap(AllPlantsby2020[,2:3],xrange=c(0,35), yrange=c(0,15), gridsep=5, title="Heat map for Bon Thomas A")

```

For the State-wide evaluation data, the locations are actually the mid-points of 1m by 1m quadrats, and the weights are the corresponding number of plants in the quadrats. The area of the plotted points is also proprtional to the number of plants.



```{r, echo=TRUE, warning=FALSE, eval=FALSE}
HeatMap(Site22[,2:3], weights=Site22$NUMPimelea,xrange=c(10,291), yrange=c(1,19), gridsep=10,title="Heat map for Site 22")

```

```{r, echo=TRUE, warning=FALSE, eval=FALSE}
HeatMap(Site29[,2:3], weights=Site29$NUMPimelea,xrange=c(11,25), yrange=c(0,11), gridsep=5,title="Heat map for Site 29")

```


```{r, echo=TRUE, warning=FALSE, eval=FALSE}
HeatMap(Site45[,2:3], weights=Site45$NUMPimelea,xrange=c(11,86), yrange=c(11,263), gridsep=20,title="Heat map for Site 45")

```



## Quadrat Probabilities

Quadrat probabilities can be calculated using the `quadratprobs()` function. Required inputs are the locations of plants, the lower left coordinate of the grid, with default (0,0), the size of the quadrats, and the minimum grid values, and the maximum grid values. In the example below, it is not necessary to specify the `quadratstart` argument aswith 5m by 5m quadrats, 5 divides 35 and 15 evenly.

```{r, echo=TRUE, warning=FALSE}
qprobs5 <- quadratprobs(AllPlantsby2020[,2:3], quadratstart=c(0,0),quadratsize=5,
                       xmin=c(0,0),xmax=c(35,15) )
knitr::kable(qprobs5, digits=3)
```
On the other hand, for 4m by 4m quadrats, it is useful to be able to specify the `quadratstart` argument. Note that only internal quadrats are included in the output of `quadratprobs()`.


```{r, echo=TRUE, warning=FALSE}
qprobs4 <- quadratprobs(AllPlantsby2020[,2:3], quadratstart="calc",quadratsize=4,
                       xmin=c(0,0),xmax=c(35,15) )
knitr::kable(qprobs4, digits=3)
```

```{r, echo=TRUE, warning=FALSE}
qprobs3 <- quadratprobs(AllPlantsby2020[,2:3], quadratstart="calc",quadratsize=3,
                       xmin=c(0,0),xmax=c(35,15) )
qprobs2 <- quadratprobs(AllPlantsby2020[,2:3], quadratstart="calc",quadratsize=2,
                       xmin=c(0,0),xmax=c(35,15) )
qprobs1 <- quadratprobs(AllPlantsby2020[,2:3], quadratstart=c(0,0),quadratsize=1,
                       xmin=c(0,0),xmax=c(35,15) )
```

## Inclusion Probabilities

Once the quadrat probabilities are calculated, the `inclusionprobs()` function can calculate the inclusion probabilities.
The following gives the inclusion probabilities for various sample sizes. The quadrats are ordered by column of the quadrat probabilities matrix with the top-left quadrat labelled **q1**.

```{r, echo=TRUE, warning=FALSE}
incprobs5 <- inclusionprobs(qprobs5,nsim=10000)
knitr::kable(incprobs5, digits=3)
```

```{r, echo=TRUE, warning=FALSE}
incprobs4 <- inclusionprobs(qprobs4,nsim=10000)
incprobs3 <- inclusionprobs(qprobs3,nsim=10000)
incprobs2 <- inclusionprobs(qprobs2,nsim=10000)
incprobs1 <- inclusionprobs(qprobs1,nsim=10000)
```

## Number of Plants Alive at a particular year

```{r, echo=TRUE, warning=FALSE}
(NumberAliveBonThomasA2020 <- NumberAlive(BonThomasA, 2020))
```



## Quadrat Counts of Changes

```{r, echo=TRUE, warning=FALSE}
Change(BonThomasA,2021, quadratsize=5)
Change(BonThomasA, 2021, quadratsize=4, quadratstart=attributes(qprobs4)$`quadratstart`)
Change(BonThomasA, 2021, quadratsize=3, quadratstart=attributes(qprobs3)$`quadratstart`)
Change(BonThomasA, 2021, quadratsize=2, quadratstart=attributes(qprobs2)$`quadratstart`)
Change(BonThomasA, 2021, quadratsize=1, quadratstart=attributes(qprobs1)$`quadratstart`)
```

```{r, echo=TRUE, warning=TRUE}
Change(BonThomasA,2021, quadratsize=4, quadratstart = c(2,1))
```

## Estimated Total

The `EstimatedTotal()` command gives the mean, standard deviation, and coefficient of variation (%) for a specified sample size.

```{r, echo=TRUE, warning=FALSE}
EstimatedTotal(ss=5,BonThomasA, 2021,  probs=qprobs5, incprobsmat=incprobs5[,-1]) 

EstimatedTotal(ss=10,BonThomasA, 2021, probs=qprobs5, incprobsmat=incprobs5[,-1]) 

EstimatedTotal(ss=15,BonThomasA, 2021,  probs=qprobs5, incprobsmat=incprobs5[,-1]) 


EstimatedTotal(ss=15,BonThomasA, 2021,  probs=qprobs4, incprobsmat=incprobs4[,-1],
               quadratstart=attributes(qprobs4)$`quadratstart`) 


EstTotalMat <- purrr::map(5:21, EstimatedTotal, site=BonThomasA, year=2021, probs=qprobs5, incprobsmat =incprobs5[,-1])

SSvsCV <- data.frame(SampleSize=5:21, CV=unlist(sapply(EstTotalMat, "[", 3)))
library(ggplot2)
ggplot2::ggplot(SSvsCV, aes(x=SampleSize, y=CV))+
  geom_line()+
  ggtitle("Bon Thomas A: 5m x 5m quadrata")+
  labs(x="sample Size", y="Coefficient of Variation (%)")
```
